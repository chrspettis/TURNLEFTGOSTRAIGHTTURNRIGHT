<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TURN-LEFT GO-STRAIGHT TURN-RIGHT</title>
    <style>
    :root {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      --bg-navy: #07183c;
      --bg-purple: #2a0d28;
      --gold: #c39d55;
      --gold-deep: #8d6636;
      --silver: #cfcbc1;
      --text: #fafbfd;
      --muted: rgba(207,203,193,.85);
      --panel: rgba(7,24,60,.45);
      --panel-2: rgba(42,13,40,.35);
      --border: rgba(195,157,85,.40);
      --border-2: rgba(195,157,85,.22);
      --shadow: rgba(0,0,0,.45);
    }

    body {
      margin: 0;
      color: var(--text);
      background:
        radial-gradient(1200px 780px at 22% 0%, rgba(195,157,85,.16), transparent 55%),
        radial-gradient(900px 650px at 85% 10%, rgba(93,109,135,.22), transparent 55%),
        linear-gradient(135deg, var(--bg-navy), var(--bg-purple) 60%, var(--bg-navy));
    }

    .wrap { max-width: 1220px; margin: 0 auto; padding: 22px; }

    h1 {
      margin: 0 0 6px;
      font-size: 24px;
      letter-spacing: .4px;
      color: var(--gold);
      text-shadow: 0 2px 14px rgba(0,0,0,.45);
    }
    .sub { margin: 0 0 16px; color: var(--muted); line-height: 1.4; }

    .grid { display: grid; grid-template-columns: 1.2fr .8fr; gap: 14px; }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }

    .panel {
      background: linear-gradient(180deg, rgba(7,24,60,.55), rgba(42,13,40,.35));
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      box-shadow: 0 18px 50px var(--shadow);
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 10px;
    }
    .stat {
      padding: 10px;
      border-radius: 10px;
      background: rgba(2,6,23,.35);
      border: 1px solid var(--border-2);
    }
    .label { display: block; font-size: 12px; color: var(--muted); }
    .value { font-size: 16px; margin-top: 2px; color: var(--text); }

    .storyBox {
      margin: 10px 0 10px;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--border-2);
      background: linear-gradient(180deg, rgba(42,13,40,.35), rgba(7,24,60,.30));
    }
    .storyTitle { font-weight: 900; letter-spacing: .2px; margin: 0 0 6px; color: var(--gold); }
    .storyObj { margin: 0; color: var(--text); line-height: 1.35; }
    .storyMeta { margin-top: 8px; color: var(--muted); font-size: 12px; line-height: 1.35; white-space: pre-wrap; }

    .goalBox {
      margin: 10px 0 12px;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--border-2);
      background: rgba(2,6,23,.28);
      display: grid;
      gap: 10px;
    }
    .goalRow { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .goalRow label { font-size: 12px; color: var(--muted); }

    select {
      background: rgba(2,6,23,.28);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 10px 10px;
      border-radius: 10px;
      min-width: 260px;
      outline: none;
    }
    select:focus { box-shadow: 0 0 0 2px rgba(195,157,85,.25); }

    .goalText { color: var(--muted); font-size: 13px; line-height:1.35; white-space: pre-wrap; }

    .signpostBox {
      margin-top: 10px;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--border-2);
      background: rgba(2,6,23,.28);
    }
    .signpostTitle { margin: 0 0 10px; font-size: 14px; letter-spacing:.2px; color: var(--gold); }
    .signGrid { display:grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    @media (max-width: 620px) { .signGrid { grid-template-columns: 1fr; } }
    .signCard {
      border-radius: 12px;
      border: 1px solid rgba(195,157,85,.18);
      background: linear-gradient(180deg, rgba(42,13,40,.25), rgba(7,24,60,.22));
      padding: 10px;
      display:grid;
      gap: 6px;
    }
    .signHdr { display:flex; justify-content:space-between; align-items:baseline; gap:10px; }
    .signDir { font-weight: 900; letter-spacing: .25px; color: var(--gold); }
    .signTag { font-size: 12px; color: var(--muted); }
    .signName { font-size: 14px; color: var(--text); font-weight: 800; line-height:1.25; }
    .signNote { font-size: 12px; color: var(--muted); line-height:1.3; }

    .buttons { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 12px; }
    button {
      cursor: pointer;
      border-radius: 10px;
      border: 1px solid rgba(207,203,193,.22);
      background: linear-gradient(180deg, rgba(195,157,85,.98), rgba(141,102,54,.98));
      color: var(--bg-navy);
      padding: 14px 10px;
      font-weight: 900;
      letter-spacing: .4px;
      box-shadow: 0 10px 28px rgba(0,0,0,.35);
    }
    button:hover { filter: brightness(1.06); }
    button:active { transform: translateY(1px); }
    button:disabled { opacity: .55; cursor: not-allowed; transform: none; }

    .row { display: flex; gap: 10px; margin-top: 12px; }
    .row button {
      flex: 1;
      font-weight: 800;
      letter-spacing: 0;
      padding: 10px;
      background: rgba(2,6,23,.28);
      border: 1px solid var(--border);
      color: var(--text);
      box-shadow: none;
    }
    .row button:hover { background: rgba(2,6,23,.40); filter:none; }

    .lists { margin-top: 12px; display: grid; gap: 10px; }
    .listBox {
      border-radius: 12px;
      border: 1px solid var(--border-2);
      background: rgba(2,6,23,.25);
      padding: 12px;
    }
    .listBox h3 { margin: 0 0 8px; font-size: 14px; color: var(--gold); letter-spacing: .2px; }

    .pillRow { display: flex; flex-wrap: wrap; gap: 8px; }
    .pill {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(195,157,85,.18);
      background: rgba(42,13,40,.18);
      color: var(--text);
      font-size: 13px;
    }
    .pill svg { width: 14px; height: 14px; opacity: .95; }

    .log {
      margin-top: 14px;
      max-height: 220px;
      overflow: auto;
      border-radius: 10px;
      border: 1px solid var(--border-2);
      background: rgba(2,6,23,.22);
      padding: 10px;
      font-size: 14px;
      line-height: 1.45;
    }
    .log p { margin: 8px 0; color: var(--text); }
    .log .muted { color: var(--muted); }

    /* Map */
    .mapHead { display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px; }
    .mapHead .hint { color: var(--muted); font-size:12px; line-height:1.3; }
    .mapWrap { border-radius:12px; border:1px solid var(--border); background: rgba(2,6,23,.22); padding:12px; }
    .mapGrid { display:grid; grid-template-columns: repeat(11, 1fr); gap:6px; }
    .cell {
      aspect-ratio: 1/1;
      border-radius: 8px;
      border: 1px solid rgba(195,157,85,.10);
      background: rgba(255,255,255,.03);
      display: grid;
      place-items: center;
      position: relative;
      overflow: hidden;
    }
    .cell.visited { background: rgba(42,13,40,.18); border-color: rgba(195,157,85,.16); }
    .cell.current { outline: 2px solid rgba(195,157,85,.92); }
    .cell .mini { width: 18px; height: 18px; opacity: .95; }
    .cell .arrow {
      width: 0; height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-bottom: 10px solid rgba(195,157,85,.95);
      transform-origin: center;
      position: absolute;
      top: 6px;
      filter: drop-shadow(0 4px 10px rgba(0,0,0,.35));
    }

    /* Modal */
    .modal-backdrop {
      position: fixed; inset: 0;
      background: rgba(2,6,23,.78);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
    }
    .modal {
      width: min(920px, 100%);
      background: linear-gradient(180deg, rgba(7,24,60,.95), rgba(42,13,40,.92));
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,.55);
    }
    .modal h2 { margin: 0 0 6px; font-size: 18px; color: var(--gold); }
    .modal .meta { color: var(--muted); font-size: 13px; margin-bottom: 10px; }
    .dialogue {
      margin-top: 10px;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid rgba(195,157,85,.18);
      background: rgba(2,6,23,.28);
      color: var(--text);
      line-height: 1.5;
      white-space: pre-wrap;
    }
    .card {
      border-radius: 12px;
      border: 1px solid rgba(195,157,85,.18);
      background: rgba(42,13,40,.18);
      padding: 12px;
      display: grid;
      grid-template-columns: 36px 1fr;
      gap: 10px;
      align-items: start;
      margin-top: 10px;
    }
    .poiIcon { width: 32px; height: 32px; opacity: .98; }
    .poi-name { font-size: 18px; font-weight: 900; margin: 0 0 6px; color: var(--gold); }
    .poi-desc { margin: 0; color: var(--text); }
    .promptNext { margin-top: 10px; color: var(--text); font-weight: 900; letter-spacing: .1px; }

    .modal .actions { margin-top: 12px; display: flex; gap: 10px; }
    .modal .actions button { flex: 1; padding: 10px; font-weight: 900; }

    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size: 12px; }
  </style>
</head>

<body>

  <div id="splash" style="
    position:fixed; inset:0; z-index:9999;
    display:flex; align-items:center; justify-content:center;
    padding:18px;
    background: rgba(2,6,23,.86);
    overflow:auto;
  ">
    <div style="
      width:min(980px, 100%);
      max-height: 92vh;
      border-radius:14px;
      border:2px solid rgba(195,157,85,.55);
      background: linear-gradient(180deg, rgba(7,24,60,.92), rgba(42,13,40,.88));
      box-shadow: 0 22px 70px rgba(0,0,0,.55);
      overflow:hidden;
    ">
      <div style="position:relative;">
        <img
          id="frontImg" src=""
          alt="TURN-LEFT GO-STRAIGHT TURN-RIGHT"
          style="display:block; width:100%; height:auto;"
        />

        <div style="position:absolute; inset:0; background: rgba(0,0,0,.28);"></div>

        <div style="
          position:absolute;
          inset:0;
          display:flex;
          flex-direction:column;
          align-items:center;
          justify-content:center;
          gap:14px;
          padding: 0 16px 70px;
        ">
          <button id="startBtn" style="
            width: min(520px, 92%);
            cursor:pointer; border-radius:12px;
            border:1px solid rgba(195,157,85,.55);
            background: rgba(2,6,23,.55);
            color: rgba(250,251,253,.96);
            padding: 16px 12px;
            font-weight: 900;
            letter-spacing: .6px;
            box-shadow: 0 10px 28px rgba(0,0,0,.35);
          ">PLAY</button>

          <a id="howToLink" href="" target="_blank" rel="noopener"
            style="
              width: min(520px, 92%);
              display:block; text-align:center; text-decoration:none;
              border-radius:12px;
              border:1px solid rgba(195,157,85,.55);
              background: rgba(2,6,23,.55);
              color: rgba(250,251,253,.96);
              padding: 16px 12px;
              font-weight: 900;
              letter-spacing: .6px;
              box-shadow: 0 10px 28px rgba(0,0,0,.35);
            ">HOW TO</a>
        </div>

        <div style="position:absolute; left:14px; bottom:12px; color:#ffffff; font-size:12px; font-weight:800; letter-spacing:.2px; opacity:.92;">© Christy Pettis 2026</div>
        <img
          id="pliLogoSplash" src=""
          alt="Proximity Learning"
          style="position:absolute; right:14px; bottom:10px; height:22px; width:auto; opacity:.95;"
        />
      </div>
    </div>
  </div>


  <div class="wrap">
    <h1>TURN-LEFT GO-STRAIGHT TURN-RIGHT</h1>
    <p class="sub">Students can preview the next three destinations and choose their route on purpose.</p>

    <div class="grid">
      <div class="panel">
        <div class="stats">
          <div class="stat"><span class="label">Position</span><span class="value" id="pos">0, 0</span></div>
          <div class="stat"><span class="label">Facing</span><span class="value" id="facing">North</span></div>
          <div class="stat"><span class="label">Moves</span><span class="value" id="moves">0</span></div>
          <div class="stat"><span class="label">Auto-Save</span><span class="value" id="saveStatus">On</span></div>
        </div>

        <div class="storyBox">
          <p class="storyTitle" id="storyTitle"></p>
          <p class="storyObj" id="storyObjective"></p>
          <div class="storyMeta" id="storyMeta"></div>
        </div>

        <div class="goalBox">
          <div class="goalRow">
            <label for="goalSelect">Student Goal:</label>
            <select id="goalSelect">
              <option value="explore">Explorer Route (reach the ending)</option>
              <option value="landmark">Landmark Route (collect places)</option>
              <option value="contact">Contact Route (meet people)</option>
              <option value="clue">Clue Route (collect objects)</option>
            </select>
          </div>
          <div class="goalText" id="goalText"></div>
        </div>

        <div class="signpostBox">
          <p class="signpostTitle">Street Signs (preview your next three options)</p>
          <div class="signGrid">
            <div class="signCard">
              <div class="signHdr">
                <div class="signDir">TURN-LEFT</div>
                <div class="signTag" id="leftTag"></div>
              </div>
              <div class="signName" id="leftName"></div>
              <div class="signNote" id="leftNote"></div>
            </div>
            <div class="signCard">
              <div class="signHdr">
                <div class="signDir">GO-STRAIGHT</div>
                <div class="signTag" id="straightTag"></div>
              </div>
              <div class="signName" id="straightName"></div>
              <div class="signNote" id="straightNote"></div>
            </div>
            <div class="signCard">
              <div class="signHdr">
                <div class="signDir">TURN-RIGHT</div>
                <div class="signTag" id="rightTag"></div>
              </div>
              <div class="signName" id="rightName"></div>
              <div class="signNote" id="rightNote"></div>
            </div>
          </div>
        </div>

        <div class="buttons">
          <button id="btnLeft" aria-label="Turn left">TURN-LEFT</button>
          <button id="btnStraight" aria-label="Go straight">GO-STRAIGHT</button>
          <button id="btnRight" aria-label="Turn right">TURN-RIGHT</button>
        </div>

        <div class="row">
          <button id="btnNew">New Game</button>
          <button id="btnClearJournal">Clear Journal</button>
          <button id="btnEraseSave">Erase Save</button>
        </div>

        <div class="lists">
          <div class="listBox">
            <h3>Clues (Objects)</h3>
            <div class="pillRow" id="invRow"></div>
          </div>
          <div class="listBox">
            <h3>Contacts (People)</h3>
            <div class="pillRow" id="peopleRow"></div>
          </div>
          <div class="listBox">
            <h3>Landmarks (Places)</h3>
            <div class="pillRow" id="placesRow"></div>
          </div>
        </div>

        <div class="log" id="log" aria-live="polite"></div>
      </div>

      <div class="panel">
        <div class="mapHead">
          <div>
            <div style="font-weight:700; letter-spacing:.2px;">Map</div>
            <div class="hint">11×11 view centered on the player. Visited tiles show type.</div>
          </div>
          <div class="hint" id="mapCenter">Center: (0, 0)</div>
        </div>

        <div class="mapWrap">
          <div class="mapGrid" id="mapGrid"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-backdrop" id="backdrop" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal">
      <h2 id="modalTitle">Travel Report</h2>
      <div class="meta" id="modalMeta"></div>

      <div class="dialogue" id="travelText"></div>

      <div class="card">
        <div id="poiIcon"></div>
        <div>
          <p class="poi-name" id="poiName"></p>
          <p class="poi-desc" id="poiDesc"></p>
        </div>
      </div>

      <div class="dialogue" id="poiDialogue" style="display:none;"></div>
      <div class="dialogue" id="fsPrompt" style="display:none;"></div>

      <div class="promptNext" id="promptNext">What direction would you like to go next?</div>

      <div class="actions">
        <button id="btnContinue">Close</button>
      </div>
      <p class="meta" style="margin-top:10px;">Tip: Press <span class="kbd">Esc</span> to close.</p>
    </div>
  </div>

<script>
/* ----------------------- Chapters ----------------------- */
const CHAPTERS = [
  { id: 0, title: "Chapter 1: The Wrong Route", objective: "Find your first clue. The city is nudging you.", hint: "Try choosing a route based on the street signs." },
  { id: 1, title: "Chapter 2: The City Answers Back", objective: "Keep collecting and watch what repeats.", hint: "Use the street signs to plan your next stop." },
  { id: 2, title: "Chapter 3: Coordinates and Names", objective: "Gather enough proof to make the city change.", hint: "Places, people, and objects can all matter." },
  { id: 3, title: "Chapter 4: The Door That Is Not a Door", objective: "The route is ready. Find the change.", hint: "If you see a sign that looks wrong, follow it." },
  { id: 4, title: "Epilogue: Route Complete", objective: "You finished the route. You can keep exploring or start again.", hint: "Start again for a new seed and new routes." }
];

/* ----------------------- POIs (lots of places for fingerspelling) ----------------------- */
const POIS = {
  places: [
    { name:"Old Brick Library", desc:"Wide steps, cool stone, and a quiet sign that looks newly polished." },
    { name:"Riverside Footbridge", desc:"Water below, wind above. The railing has fresh scratches like coordinates." },
    { name:"Neon Corner Diner", desc:"Warm lights, clinking plates, and a menu that changes when you glance away." },
    { name:"Community Garden Gate", desc:"A painted sign, a stubborn latch, and rows of herbs that smell like rain." },
    { name:"Abandoned Tram Stop", desc:"A schedule that lists stops you cannot find anywhere else." },
    { name:"Clocktower Plaza", desc:"The chime is late by one beat. Every time." },

    { name:"Juniper Hill Observatory", desc:"A dome on a hill with benches facing the sky like an audience." },
    { name:"Maple Street Arcade", desc:"Faded posters, bright screens, and a prize counter that never closes." },
    { name:"Silverline Train Station", desc:"Announcements echo. The platform numbers feel rearranged." },
    { name:"Cedar Grove Playground", desc:"New swings, old footprints, and a fence that rattles in the breeze." },
    { name:"Granite Steps Amphitheater", desc:"Tiered seats, a hollow stage, and acoustics that make whispers travel." },
    { name:"Westbrook Art Gallery", desc:"White walls, soft lighting, and one frame hanging slightly crooked." },
    { name:"Harborview Pier", desc:"Wood planks, salt air, and gulls that watch like guards." },
    { name:"Ashwood Bookshop", desc:"Stacks of used books with handwritten notes in the margins." },
    { name:"Orchard Lane Bakery", desc:"Warm bread smell, flour dust, and a bell that rings too loudly." },
    { name:"Winding Willow Park", desc:"A curved path, long shadows, and a bench with initials carved fresh." },
    { name:"Magnolia Movie House", desc:"A single-screen theater playing something you swear you remember." },
    { name:"Brighton Aquarium Hall", desc:"Blue light, quiet tanks, and fish that never stop moving." },
    { name:"Rosewater Conservatory", desc:"Glass walls, damp air, and plants that lean toward you." },
    { name:"Hollow Creek Trailhead", desc:"A trail map with a missing corner and a posted warning without details." },
    { name:"Northgate Museum Annex", desc:"A side entrance with a lock that looks recently replaced." },
    { name:"Lakeside Picnic Shelter", desc:"A roof, a table, and a cooler stain shaped like a question mark." },
    { name:"Sunrise Community Pool", desc:"Still water, echoing tiles, and a lifeguard chair turned sideways." },
    { name:"Ironwood Hardware Mart", desc:"Aisles of tools and a clerk who watches your hands." },
    { name:"Pinecrest Post Office", desc:"A row of boxes and one slot labeled with no name." },
    { name:"Evergreen Coffee Roasters", desc:"Bitter smell, soft music, and a barista who already knows your order." },
    { name:"Elmwood Community Center", desc:"A bulletin board full of announcements dated tomorrow." },
    { name:"Mariner’s Lighthouse Steps", desc:"Cold railings and a spiral climb that feels longer than it should." },
    { name:"Foxglove Farmers Market", desc:"Fresh produce and a vendor who sells maps with no streets." },
    { name:"Summit View Overlook", desc:"A wide horizon and a sign that points to places that are not visible." },
    { name:"Brookstone Covered Bridge", desc:"Old wood beams and a creek that sounds like murmured speech." },
    { name:"Lantern Alley Courtyard", desc:"String lights and footprints leading in two directions at once." },
    { name:"Prairie Street Planetarium", desc:"Dark halls and constellations that feel rearranged." },
    { name:"Ravenwood Music Conservatory", desc:"Practice rooms and a distant melody you cannot place." },
    { name:"Cobalt Ice Rink Pavilion", desc:"Cold air and skate marks that loop like a spiral." },
    { name:"Goldenrod Flower Shop", desc:"Bright petals and a back room curtain that keeps moving." },
    { name:"Briarwood Bicycle Co-Op", desc:"Oil smell, spare parts, and a bell that rings when nobody enters." },
    { name:"Hearthstone Antique Mall", desc:"Dusty shelves and a mirror that reflects a hallway behind you." },
    { name:"Seabreeze Kite Field", desc:"Open grass and a wind that seems to push you toward one corner." },
    { name:"Fairview Courthouse Steps", desc:"Tall columns and voices that fade as you get closer." },
    { name:"Crescent Street Laundromat", desc:"Spinning drums and a coin return that clicks at random." },
    { name:"Meadowlark Music Kiosk", desc:"A small stage and sheet music pinned down with a stone." },
    { name:"Redstone Firehouse Bay", desc:"Polished floors and a siren switch labeled with no words." },
    { name:"Glimmerglass Watch Shop", desc:"Ticking everywhere and a clock that runs backward for a second." },
    { name:"Horizon Bus Terminal", desc:"Routes posted, departures listed, and one line left blank." },
    { name:"Sequoia Public Archives", desc:"Index cards and a catalog drawer stuck halfway open." },
    { name:"Kestrel Hill Windmill", desc:"Slow blades and a shadow that turns the wrong way." },
    { name:"Bluebird Botanical Walk", desc:"Labeled plants and labels that look newly rewritten." },
    { name:"Kingfisher Canal Lock", desc:"Metal gates and water that rises with a quiet groan." },

    { name:"Amberstone Pottery Studio", desc:"Clay dust and unfinished mugs lined in perfect rows." },
    { name:"Violet Ridge Lookout", desc:"A high ledge and a railing warm from the sun." },
    { name:"Oakshade Tennis Courts", desc:"Silent nets and ball marks that appear too fresh." },
    { name:"Marblebrook Fountain Square", desc:"Water arcs and coins that look recently dropped." },
    { name:"Crescent Moon Tea Room", desc:"Steaming cups and a note slipped under a saucer." },
    { name:"Sandstone Row Townhouses", desc:"Identical doors and one door painted a slightly different shade." },
    { name:"Willowbend Reading Nook", desc:"A tiny park corner with a free book box and a bench." },
    { name:"Linden Street Sculpture Walk", desc:"Metal art and footprints circling one statue repeatedly." },
    { name:"Copperleaf Community Radio", desc:"A studio window and a red light that flickers." },
    { name:"Harborstone Ferry Ramp", desc:"Wet boards and a horn you feel in your ribs." },
    { name:"Glassbridge Pedestrian Tunnel", desc:"A tunnel of glass blocks, light bending in odd angles." },
    { name:"Marbleline University Quad", desc:"Quiet lawns and a bell schedule posted for the wrong semester." },
    { name:"Windmere Riverside Steps", desc:"Stone steps down to water and a handprint in dried mud." }
  ],
  objects: [
    { name:"Map Fragment", desc:"A torn map piece showing streets that do not match the city." },
    { name:"Pocket Compass", desc:"The needle points somewhere that feels personal, not north." },
    { name:"Rusty Key", desc:"Heavy. The tag reads: 'Not the front door.'" },
    { name:"Polaroid Photo", desc:"A snapshot of this spot taken from an angle you cannot find." },
    { name:"Tin Music Box", desc:"A melody you do not remember learning lands perfectly in your memory." },
    { name:"Chalk Marker", desc:"The chalk never runs out. The cap smells like rain." },
    { name:"Receipt With No Store", desc:"A paper slip listing an item that is not sold anywhere." },
    { name:"Brass Token", desc:"A token stamped with a street name you have not seen yet." },
    { name:"Glass Marble", desc:"A clear marble with a dark swirl that looks like a tiny map." },
    { name:"Library Card", desc:"A card with your name spelled correctly, including the middle initial." },
    { name:"Envelope of Coordinates", desc:"An envelope labeled with numbers and no return address." },
    { name:"Bent Street Sign", desc:"A small metal sign that reads 'TURN' in neat letters." }
  ],
  people: [
    { name:"The Street Artist", desc:"They watch your hands instead of your face." },
    { name:"The Lost Tourist", desc:"They look lost, but their questions are too specific." },
    { name:"The Night Courier", desc:"They do not blink when you say you are not expecting mail." },
    { name:"The Archivist", desc:"They speak like every moment should be filed and labeled." },
    { name:"The Mechanic", desc:"They listen to the air and say the city has a rhythm." },
    { name:"The Quiet Neighbor", desc:"They know your name. You have never met them." },
    { name:"The Crossing Guard", desc:"They raise a hand like they are controlling time." },
    { name:"The Bench Reader", desc:"They never look up, but they turn pages at the exact right moment." },
    { name:"The Open-Shop Owner", desc:"They wave you in like you were expected." },
    { name:"The Night Runner", desc:"They pass by twice, like they are looping the same block." }
  ]
};

/* ----------------------- Icons (SVG) ----------------------- */
function iconSVG(type, size=32) {
  const common = `width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"`;
  if (type === "places") {
    return `<svg ${common} class="poiIcon"><path d="M12 21s7-4.5 7-11a7 7 0 10-14 0c0 6.5 7 11 7 11z" stroke="var(--gold)" stroke-width="1.7"/><path d="M12 13.2a3.2 3.2 0 100-6.4 3.2 3.2 0 000 6.4z" stroke="var(--gold)" stroke-width="1.7"/></svg>`;
  }
  if (type === "objects") {
    return `<svg ${common} class="poiIcon"><path d="M6.5 9.5l5.5-3 5.5 3v7l-5.5 3-5.5-3v-7z" stroke="var(--gold)" stroke-width="1.7" /><path d="M12 6.5v13" stroke="rgba(207,203,193,.75)" stroke-width="1.2"/></svg>`;
  }
  return `<svg ${common} class="poiIcon"><path d="M12 12.2a4 4 0 100-8 4 4 0 000 8z" stroke="var(--gold)" stroke-width="1.7"/><path d="M4.5 20c1.7-3.7 5-5.5 7.5-5.5S17.8 16.3 19.5 20" stroke="var(--gold)" stroke-width="1.7" stroke-linecap="round"/></svg>`;
}
function miniIcon(type) { return iconSVG(type, 18).replace('class="poiIcon"', 'class="mini"'); }

/* ----------------------- Save/Load ----------------------- */
const SAVE_KEY = "TLGS_TR_student_paths_v4";

let state = null;

function serializeState(st) {
  return JSON.stringify({
    seed: st.seed,
    x: st.x, y: st.y,
    facing: st.facing,
    moves: st.moves,
    visited: Array.from(st.visited),
    discovered: Array.from(st.discovered.entries()),
    inventory: Array.from(st.inventory),
    metPeople: Array.from(st.metPeople),
    foundPlaces: Array.from(st.foundPlaces),
    story: st.story,
    studentGoal: st.studentGoal
  });
}
function deserializeState(json) {
  const o = JSON.parse(json);
  return {
    seed: o.seed,
    x: o.x, y: o.y,
    facing: o.facing,
    moves: o.moves,
    visited: new Set(o.visited || []),
    discovered: new Map(o.discovered || []),
    inventory: new Set(o.inventory || []),
    metPeople: new Set(o.metPeople || []),
    foundPlaces: new Set(o.foundPlaces || []),
    story: o.story || { chapter: 0, journal: [], flags: {} },
    studentGoal: o.studentGoal || "explore"
  };
}
function saveGame() {
  try {
    localStorage.setItem(SAVE_KEY, serializeState(state));
    setText("saveStatus", "Saved");
    window.setTimeout(() => setText("saveStatus", "On"), 600);
  } catch {
    setText("saveStatus", "Save Failed");
  }
}
function loadGameIfPresent() {
  const raw = localStorage.getItem(SAVE_KEY);
  if (!raw) return false;
  try { state = deserializeState(raw); return true; } catch { return false; }
}
function eraseSave() {
  localStorage.removeItem(SAVE_KEY);
  setText("saveStatus", "Erased");
  window.setTimeout(() => setText("saveStatus", "On"), 800);
}

/* ----------------------- Deterministic selection ----------------------- */
function hash32(n) {
  n = (n ^ (n >>> 16)) >>> 0;
  n = Math.imul(n, 0x7feb352d) >>> 0;
  n = (n ^ (n >>> 15)) >>> 0;
  n = Math.imul(n, 0x846ca68b) >>> 0;
  n = (n ^ (n >>> 16)) >>> 0;
  return n >>> 0;
}
function computePOI(x, y) {
  const base = (state.seed ^ (x * 374761393) ^ (y * 668265263)) >>> 0;
  const h = hash32(base);
  const types = ["places", "objects", "people"];
  const type = types[h % types.length];
  const list = POIS[type];
  const idx = (hash32(h ^ 0x9e3779b9) % list.length) >>> 0;
  const poi = { ...list[idx], type };
  return poi;
}
function pickPOI(x, y) {
  const key = `${x},${y}`;
  if (state.discovered.has(key)) return { poi: state.discovered.get(key), isNewTile: false };
  const poi = computePOI(x, y);
  state.discovered.set(key, poi);
  return { poi, isNewTile: true };
}

/* ----------------------- Story logic ----------------------- */
function updateChapterIfNeeded() {
  const clues = state.inventory.size;
  const contacts = state.metPeople.size;
  const landmarks = state.foundPlaces.size;

  if (state.story.flags.endingReached) { state.story.chapter = 4; return; }

  if (state.story.chapter === 0 && (clues + contacts + landmarks) >= 2) state.story.chapter = 1;
  if (state.story.chapter === 1 && (clues >= 2 || contacts >= 2 || landmarks >= 3)) state.story.chapter = 2;
  if (state.story.chapter === 2 && (clues >= 3 && contacts >= 2 && landmarks >= 2)) state.story.chapter = 3;
}
function storyIntroIfNew() {
  if (state.story.flags.started) return;
  state.story.flags.started = true;
  journalEntry("Journal: The city reacts to every direction choice.");
  journalEntry("Journal: The street signs feel like a challenge.");
}
function journalEntry(text) {
  state.story.journal.push({ t: Date.now(), text });
  if (state.story.journal.length > 140) state.story.journal.shift();
  writeLog(text);
}

/* ----------------------- Student goal logic ----------------------- */
const GOALS = {
  explore: {
    title: "Explorer Route",
    desc: "Goal: Reach the ending (Hidden Doorway Passage).\nStrategy: Use the street signs to choose a route you like.\nTeacher option: Require 15 moves, then stop and summarize the journey."
  },
  landmark: {
    title: "Landmark Route",
    desc: "Goal: Collect 8 different places.\nStrategy: Use the street signs to chase new place names.\nTeacher option: Each move, fingerspell the previewed place name before choosing."
  },
  contact: {
    title: "Contact Route",
    desc: "Goal: Meet 5 different people.\nStrategy: Use the street signs to chase different encounters.\nTeacher option: After meeting a person, retell what they did in 1 sentence."
  },
  clue: {
    title: "Clue Route",
    desc: "Goal: Collect 6 different objects.\nStrategy: Use the street signs to hunt objects.\nTeacher option: After finding an object, write what it might be used for."
  }
};

function goalProgressText() {
  const g = state.studentGoal;
  if (g === "landmark") return `Progress: ${state.foundPlaces.size}/8 places`;
  if (g === "contact") return `Progress: ${state.metPeople.size}/5 people`;
  if (g === "clue") return `Progress: ${state.inventory.size}/6 objects`;
  return "Progress: Reach the ending";
}
function goalComplete() {
  const g = state.studentGoal;
  if (g === "landmark") return state.foundPlaces.size >= 8;
  if (g === "contact") return state.metPeople.size >= 5;
  if (g === "clue") return state.inventory.size >= 6;
  return state.story.flags.endingReached === true;
}

/* ----------------------- Travel narration ----------------------- */
function actionText(choice) {
  return (choice === "LEFT") ? "TURN-LEFT" : (choice === "RIGHT") ? "TURN-RIGHT" : "GO-STRAIGHT";
}
function stepCount(choice, x, y) {
  const salt = (choice === "LEFT") ? 101 : (choice === "RIGHT") ? 202 : 303;
  const h = hash32((state.seed ^ (x * 9137) ^ (y * 6949) ^ salt) >>> 0);
  return 3 + (h % 5); // 3–7
}
function pickLine(lines, choice, x, y, extra=0) {
  const salt = (choice === "LEFT") ? 1111 : (choice === "RIGHT") ? 2222 : 3333;
  const h = hash32((state.seed ^ (x * 1297) ^ (y * 3253) ^ salt ^ extra) >>> 0);
  return lines[h % lines.length];
}
function travelNarration(choice, steps, poi, isNewTile) {
  const chap = state.story.chapter;

  const leftOpeners = [
    "You turned left without hesitation.",
    "You turned left and the city seemed to lean closer.",
    "You turned left, following the street sign like a dare."
  ];
  const leftMoments = [
    "You pass a window with a curtain that moves too slowly.",
    "You step around a crack in the sidewalk shaped like an arrow.",
    "The air smells like wet stone near the corner."
  ];

  const straightOpeners = [
    "You went straight and kept your pace steady.",
    "You went straight as if you were following a rule you never agreed to.",
    "You went straight and tried to pretend this is normal."
  ];
  const straightMoments = [
    "The block feels longer than it should, like someone stretched it.",
    "A distant tap-tap-tap repeats, then stops when you look around.",
    "You pass a street sign that looks freshly reattached."
  ];

  const rightOpeners = [
    "You turned right and looked both ways before crossing.",
    "You turned right and watched the intersection like it might argue.",
    "You turned right as a gust of wind pushed at your shoulder."
  ];
  const rightMoments = [
    "A car rushes by too fast, then the street goes quiet again.",
    "A bicycle bell rings once and then there is nothing.",
    "A crossing signal blinks even though no one is waiting."
  ];

  const opener = (choice === "LEFT")
    ? pickLine(leftOpeners, choice, state.x, state.y, 1)
    : (choice === "RIGHT")
      ? pickLine(rightOpeners, choice, state.x, state.y, 1)
      : pickLine(straightOpeners, choice, state.x, state.y, 1);

  const moment = (choice === "LEFT")
    ? pickLine(leftMoments, choice, state.x, state.y, 2)
    : (choice === "RIGHT")
      ? pickLine(rightMoments, choice, state.x, state.y, 2)
      : pickLine(straightMoments, choice, state.x, state.y, 2);

  const chapterBeat =
    (chap <= 1) ? "It still feels like a coincidence—almost."
    : (chap === 2) ? "The route tightens around your choices."
    : (chap >= 3) ? "You can feel the city waiting for you to finish the pattern."
    : "";

  const revisitBeat = isNewTile ? "New ground." : "You have been here before, and the city remembers.";

  const arrivalLead = (poi.type === "places") ? "front steps of the"
    : (poi.type === "people") ? "corner where you spot"
    : "spot where you notice";

  const arrival = `You walked ${steps} steps and arrived at the ${arrivalLead} ${poi.name}.`;

  return `${opener}\n${moment}\n${revisitBeat}\n${chapterBeat}\n\n${arrival}`;
}

/* ----------------------- NPC dialogue (light) ----------------------- */
function dialogueForPOI(poi, isNewTile) {
  if (!isNewTile) return "";
  if (poi.type === "people") {
    if (poi.name === "The Archivist") return "Archivist: Collect proof. The city respects proof.\nArchivist: Choose your route on purpose.";
    if (poi.name === "The Night Courier") return "Courier: Keep moving.\nCourier: The street signs are not random.";
    if (poi.name === "The Crossing Guard") return "Crossing Guard: Wait. Look. Now go.\nCrossing Guard: Attention is part of the route.";
    return "They hold your gaze like they already understand the route you are walking.";
  }
  if (poi.type === "objects") return "You turn the item over in your hands and feel the route pull a little tighter.";
  return "";
}

/* ----------------------- Ending trigger ----------------------- */
function maybeTriggerEndingOnPlace(poi, isNewTile) {
  if (state.story.chapter !== 3) return null;
  if (!isNewTile || poi.type !== "places" || state.story.flags.endingReached) return null;

  state.story.flags.endingReached = true;
  state.story.chapter = 4;

  return {
    type: "places",
    id: "ending",
    name: "Hidden Doorway Passage",
    desc:
      "For a half-second, the landmark is itself.\n" +
      "Then the city swaps the scene like changing a backdrop.\n\n" +
      "A narrow door appears where there was solid stone.\n" +
      "No handle. No frame. Just a seam and the feeling that this is the answer.\n\n" +
      "The route releases you like a held breath."
  };
}

/* ----------------------- Game state ----------------------- */
function newSeed() { return (Date.now() >>> 0); }
function facingName(f) { return ["North","East","South","West"][f] || "North"; }

function resetGame() {
  state = {
    seed: newSeed(),
    x: 0, y: 0,
    facing: 0,
    moves: 0,
    visited: new Set(["0,0"]),
    discovered: new Map(),
    inventory: new Set(),
    metPeople: new Set(),
    foundPlaces: new Set(),
    story: { chapter: 0, journal: [], flags: {} },
    studentGoal: (document.getElementById("goalSelect").value || "explore")
  };
  setLog("");
  storyIntroIfNew();
  pickPOI(0, 0);
  syncAll();
  saveGame();
}

/* ----------------------- Movement helpers ----------------------- */
function turn(delta, facing) { return (facing + delta + 4) % 4; }
function stepForwardFrom(x, y, facing) {
  if (facing === 0) return { x, y: y + 1 };
  if (facing === 1) return { x: x + 1, y };
  if (facing === 2) return { x, y: y - 1 };
  return { x: x - 1, y };
}

/* ----------------------- UI helpers ----------------------- */
function setText(id, text) { document.getElementById(id).textContent = text; }
function setLog(html) { document.getElementById("log").innerHTML = html; }
function writeLog(msg, muted=false) {
  const log = document.getElementById("log");
  const p = document.createElement("p");
  p.textContent = msg;
  if (muted) p.classList.add("muted");
  log.appendChild(p);
  log.scrollTop = log.scrollHeight;
}
function labelForType(type) {
  if (type === "places") return "Place";
  if (type === "objects") return "Object";
  if (type === "people") return "Person";
  return "Point of Interest";
}
function setMoveButtonsEnabled(enabled) {
  document.getElementById("btnLeft").disabled = !enabled;
  document.getElementById("btnStraight").disabled = !enabled;
  document.getElementById("btnRight").disabled = !enabled;
}
function showModal(meta, travelText, poi, dialogue, goalResultLine) {
  document.getElementById("modalMeta").textContent = meta;
  document.getElementById("travelText").textContent = travelText;

  document.getElementById("poiIcon").innerHTML = iconSVG(poi.type, 32);
  document.getElementById("poiName").textContent = `${labelForType(poi.type)}: ${poi.name}`;
  document.getElementById("poiDesc").textContent = poi.desc;

  const d = document.getElementById("poiDialogue");
  if (dialogue && dialogue.trim().length) {
    d.style.display = "block";
    d.textContent = dialogue;
  } else {
    d.style.display = "none";
    d.textContent = "";
  }

  const fs = document.getElementById("fsPrompt");
  fs.style.display = "block";
  fs.textContent = `Fingerspelling practice:\nSpell the destination name:\n${poi.name}`;

  document.getElementById("promptNext").textContent = goalResultLine
    ? `${goalResultLine}\n\nWhat direction would you like to go next?`
    : "What direction would you like to go next?";

  document.getElementById("backdrop").style.display = "flex";
  setMoveButtonsEnabled(false);
}
function hideModal() {
  document.getElementById("backdrop").style.display = "none";
  setMoveButtonsEnabled(true);
}

/* ----------------------- Rendering ----------------------- */
function syncStats() {
  setText("pos", `${state.x}, ${state.y}`);
  setText("facing", facingName(state.facing));
  setText("moves", String(state.moves));
}
function syncStoryBox() {
  updateChapterIfNeeded();
  const c = CHAPTERS[Math.min(state.story.chapter, CHAPTERS.length - 1)];
  setText("storyTitle", c.title);
  setText("storyObjective", c.objective);

  const meta =
    `Goal: ${GOALS[state.studentGoal].title}\n` +
    `${goalProgressText()}\n` +
    `Clues: ${state.inventory.size}   Contacts: ${state.metPeople.size}   Places: ${state.foundPlaces.size}\n` +
    `Hint: ${c.hint}`;
  document.getElementById("storyMeta").textContent = meta;

  document.getElementById("goalText").textContent = GOALS[state.studentGoal].desc;
}
function pill(type, text) {
  const div = document.createElement("div");
  div.className = "pill";
  div.innerHTML = `${iconSVG(type, 14).replace('class="poiIcon"', '')}<span>${text}</span>`;
  return div;
}
function syncLists() {
  const invRow = document.getElementById("invRow");
  const peopleRow = document.getElementById("peopleRow");
  const placesRow = document.getElementById("placesRow");
  invRow.innerHTML = "";
  peopleRow.innerHTML = "";
  placesRow.innerHTML = "";

  if (state.inventory.size === 0) invRow.appendChild(pill("objects", "None yet"));
  else [...state.inventory].forEach(name => invRow.appendChild(pill("objects", name)));

  if (state.metPeople.size === 0) peopleRow.appendChild(pill("people", "None yet"));
  else [...state.metPeople].forEach(name => peopleRow.appendChild(pill("people", name)));

  if (state.foundPlaces.size === 0) placesRow.appendChild(pill("places", "None yet"));
  else [...state.foundPlaces].forEach(name => placesRow.appendChild(pill("places", name)));
}
function syncMap() {
  const grid = document.getElementById("mapGrid");
  setText("mapCenter", `Center: (${state.x}, ${state.y})`);
  grid.innerHTML = "";

  const radius = 5;
  for (let dy = radius; dy >= -radius; dy--) {
    for (let dx = -radius; dx <= radius; dx++) {
      const x = state.x + dx;
      const y = state.y + dy;
      const key = `${x},${y}`;

      const cell = document.createElement("div");
      cell.className = "cell";

      const isVisited = state.visited.has(key);
      const isCurrent = (x === state.x && y === state.y);

      if (isVisited) cell.classList.add("visited");
      if (isCurrent) cell.classList.add("current");

      if (isVisited) {
        const poi = state.discovered.get(key);
        if (poi) cell.innerHTML = miniIcon(poi.type);
      }

      if (isCurrent) {
        const arrow = document.createElement("div");
        arrow.className = "arrow";
        const deg = state.facing === 0 ? 0 : state.facing === 1 ? 90 : state.facing === 2 ? 180 : 270;
        arrow.style.transform = `rotate(${deg}deg)`;
        cell.appendChild(arrow);
      }

      grid.appendChild(cell);
    }
  }
}

function computePreview(choice) {
  let f = state.facing;
  if (choice === "LEFT") f = turn(-1, f);
  if (choice === "RIGHT") f = turn(1, f);
  const next = stepForwardFrom(state.x, state.y, f);
  const key = `${next.x},${next.y}`;

  // If in Chapter 4 setup and the next tile would trigger the ending,
  // preview a "changed" sign to emphasize purposeful choice.
  const isUnvisited = !state.visited.has(key);
  const basePOI = state.discovered.has(key) ? state.discovered.get(key) : computePOI(next.x, next.y);

  if (state.story.chapter === 3 && !state.story.flags.endingReached && isUnvisited && basePOI.type === "places") {
    return {
      name: "A Sign That Looks Wrong",
      tag: "Possible Change",
      note: "This sign feels different. If you want the ending, try this route."
    };
  }

  const tag = state.visited.has(key) ? "Visited" : "New";
  const note = (basePOI.type === "places")
    ? "Good for fingerspelling place names."
    : (basePOI.type === "people")
      ? "Good for meeting contacts."
      : "Good for collecting clues.";

  return { name: basePOI.name, tag, note };
}

function syncSignposts() {
  const L = computePreview("LEFT");
  const S = computePreview("STRAIGHT");
  const R = computePreview("RIGHT");

  setText("leftName", L.name);
  setText("leftTag", L.tag);
  setText("leftNote", L.note);

  setText("straightName", S.name);
  setText("straightTag", S.tag);
  setText("straightNote", S.note);

  setText("rightName", R.name);
  setText("rightTag", R.tag);
  setText("rightNote", R.note);
}

function syncAll() {
  syncStats();
  syncStoryBox();
  syncLists();
  syncMap();
  syncSignposts();
}

/* ----------------------- Main action ----------------------- */
function chooseDirection(choice) {
  storyIntroIfNew();

  // apply turn
  if (choice === "LEFT") state.facing = turn(-1, state.facing);
  if (choice === "RIGHT") state.facing = turn(1, state.facing);

  // step forward
  const next = stepForwardFrom(state.x, state.y, state.facing);
  state.x = next.x;
  state.y = next.y;

  state.moves += 1;

  const posKey = `${state.x},${state.y}`;
  state.visited.add(posKey);

  const { poi: rawPOI, isNewTile } = pickPOI(state.x, state.y);

  // Collect on first visit
  if (isNewTile) {
    if (rawPOI.type === "objects") {
      state.inventory.add(rawPOI.name);
      journalEntry(`Journal: Clue collected: ${rawPOI.name}.`);
    }
    if (rawPOI.type === "people") {
      state.metPeople.add(rawPOI.name);
      journalEntry(`Journal: Contact met: ${rawPOI.name}.`);
    }
    if (rawPOI.type === "places") {
      state.foundPlaces.add(rawPOI.name);
      journalEntry(`Journal: Place visited: ${rawPOI.name}.`);
    }
  }

  updateChapterIfNeeded();

  // Ending can override destination place in Chapter 4 setup
  let poi = rawPOI;
  const ending = maybeTriggerEndingOnPlace(rawPOI, isNewTile);
  if (ending) {
    poi = ending;
    journalEntry("Journal: The city changed a place into something else.");
  }

  const steps = stepCount(choice, state.x, state.y);
  const travelText = travelNarration(choice, steps, poi, isNewTile);
  const meta = `${actionText(choice)} -> (${state.x}, ${state.y}) facing ${facingName(state.facing)}.`;

  const dialogue = dialogueForPOI(poi, isNewTile);

  syncAll();
  saveGame();

  let goalLine = "";
  if (goalComplete()) {
    goalLine = `Student Goal Completed: ${GOALS[state.studentGoal].title}`;
  } else {
    goalLine = `Student Goal: ${GOALS[state.studentGoal].title} (${goalProgressText()})`;
  }

  showModal(meta, travelText, poi, dialogue, goalLine);
}

/* ----------------------- Boot + Journal display ----------------------- */
function renderJournalFromState() {
  setLog("");
  const items = state.story.journal.slice(-45);
  for (const it of items) writeLog(it.text);
  if (items.length === 0) writeLog("Journal is empty.", true);
}
function clearJournal() {
  state.story.journal = [];
  setLog("");
  writeLog("Journal cleared.", true);
  saveGame();
}

/* ----------------------- Wiring ----------------------- */
document.getElementById("btnLeft").addEventListener("click", () => chooseDirection("LEFT"));
document.getElementById("btnStraight").addEventListener("click", () => chooseDirection("STRAIGHT"));
document.getElementById("btnRight").addEventListener("click", () => chooseDirection("RIGHT"));

document.getElementById("btnNew").addEventListener("click", () => resetGame());
document.getElementById("btnClearJournal").addEventListener("click", () => clearJournal());
document.getElementById("btnEraseSave").addEventListener("click", () => {
  eraseSave();
  writeLog("Saved game erased.", true);
});

document.getElementById("btnContinue").addEventListener("click", hideModal);
document.addEventListener("keydown", (e) => { if (e.key === "Escape") hideModal(); });
document.getElementById("backdrop").addEventListener("click", (e) => { if (e.target.id === "backdrop") hideModal(); });

document.getElementById("goalSelect").addEventListener("change", () => {
  if (!state) return;
  state.studentGoal = document.getElementById("goalSelect").value;
  syncAll();
  saveGame();
});

/* ----------------------- Start ----------------------- */
(function boot() {
  const loaded = loadGameIfPresent();
  if (loaded) {
    // set UI goal selector from saved
    document.getElementById("goalSelect").value = state.studentGoal || "explore";
    renderJournalFromState();
    syncAll();
  } else {
    resetGame();
  }
})();
</script>

<script>
  (function(){
    var splash = document.getElementById('splash');
    var btn = document.getElementById('startBtn');
    if (btn && splash) {
      btn.addEventListener('click', function(){
        splash.style.display = 'none';
      });
    }
  })();
</script>


  <div id="tlgs-footer" style="
    position: fixed;
    left: 14px;
    right: 14px;
    bottom: 10px;
    z-index: 10;
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    gap: 10px;
    opacity: .85;
    pointer-events: none;
  ">
    <div style="color:#ffffff; font-size:12px; font-weight:800; letter-spacing:.2px;">© Christy Pettis 2026</div>
    <img
      id="pliLogoFooter" src=""
      alt="Proximity Learning"
      style="height:22px; width:auto;"
    />
  </div>

  <!-- CANVAS FILE IDS: Update these if you upload as NEW files. If you REPLACE files in Canvas, IDs stay the same. -->
  <script>
  (function(){
    const TLGS_CANVAS = {
      courseId: '7812102',
      frontImageFileId: '340711992',
      pliLogoFileId: '340712000',
      instructionsPdfFileId: '340653705'
    };
    const base = 'https://proximity.instructure.com/courses/' + TLGS_CANVAS.courseId + '/files/';
    const api  = 'https://proximity.instructure.com/api/v1/courses/' + TLGS_CANVAS.courseId + '/files/';
    function setImg(el, fileId){ if(!el||!fileId) return; el.src = base + fileId + '/preview'; el.setAttribute('data-api-endpoint', api + fileId); el.setAttribute('data-api-returntype','File'); }
    function setLink(el, fileId){ if(!el||!fileId) return; el.href = base + fileId + '/preview'; el.setAttribute('data-api-endpoint', api + fileId); el.setAttribute('data-api-returntype','File'); }
    setImg(document.getElementById('frontImg'), TLGS_CANVAS.frontImageFileId);
    setImg(document.getElementById('pliLogoSplash'), TLGS_CANVAS.pliLogoFileId);
    setImg(document.getElementById('pliLogoFooter'), TLGS_CANVAS.pliLogoFileId);
    setLink(document.getElementById('howToLink'), TLGS_CANVAS.instructionsPdfFileId);
  })();
  </script>
</body>
</html>
